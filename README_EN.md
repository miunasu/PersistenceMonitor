# PersistenceMonitor

A Windows persistence mechanism monitoring tool designed for malware analysis and security research. Detects persistence behavior through before/after snapshot comparison and ETW file event tracing.

## Highlights: Clear and Readable Reports

This tool generates structured plain-text reports that are **efficient for both human analysts and AI Agents**:

- **Plain Text Format**: No special tools needed - open and view with any text editor
- **Clear Categorization**: Organized by `ADDED_*`, `REMOVED_*`, `MODIFIED_*` for quick navigation
- **Risk Marking**: High-risk items are clearly flagged for prioritized handling
- **Complete Context**: Reports contain sufficient context for in-depth analysis

### Usage Examples

![Script Running Screenshot](img/running.png)

*Running the monitoring script to automatically capture target program's persistence behavior*

**Manual Analysis**: Read report files directly, analyze based on categories and risk markers

**AI Agent Assisted Analysis**: Report format is Agent-friendly - pass the report directory to an AI Agent for automated analysis

![Agent Analysis Example](img/spore.png)

*AI Agent reads the report and automatically identifies malicious behavior patterns with professional assessment*

> The `example/` directory contains complete usage examples:
> - `persistence_report_malware_20260202_165357/` - Actual output from the screenshots above
> - `cloudflare.mem` - Complete conversation log of AI Agent analyzing the report
> - `Report.md` - Final analysis report generated by the Agent

## Features

- **Before/After Snapshot Comparison**: Captures system state before and after running a target executable
- **ETW File Tracing**: Real-time file system event capture using ETW to record program's file operations
- **Comprehensive Persistence Detection**:
  - Registry autorun keys (Run, RunOnce, Winlogon, IFEO, etc.)
  - Windows Services
  - Scheduled Tasks
  - Startup Folders
  - WMI Event Subscriptions
  - BITS Jobs
  - PowerShell Profiles
  - Kernel Drivers
- **Network Connection Monitoring**: Tracks new network connections established by the target
- **Process Monitoring**: Detects newly spawned processes
- **Detailed Reports**: Generates comprehensive reports with risk assessment

## Requirements

- Windows 10/11 or Windows Server 2016+
- Python 3.8+
- Administrator privileges (required for ETW)

## Installation

```bash
git clone https://github.com/miunasu/PersistenceMonitor.git
cd PersistenceMonitor
```

No additional dependencies required - uses only Python standard library and Windows APIs.

## Usage

```bash
# Basic usage
python -m PersistenceMonitor.main <target_executable> [wait_seconds]

# Example: Monitor a suspicious file for 60 seconds
python -m PersistenceMonitor.main suspicious.exe 60

# Default wait time is 30 seconds
python -m PersistenceMonitor.main malware_sample.exe
```

The tool will:
1. Take a system snapshot (registry, services, tasks, etc.)
2. Start ETW file monitoring
3. Execute the target program
4. Wait for the specified duration
5. Stop monitoring and take another snapshot
6. Compare snapshots and generate a report

## Output

Reports are saved to `persistence_report_<filename>_<timestamp>/` directory containing:

- `00_SUMMARY.txt` - Overview and risk assessment
- `ADDED_*.txt` - Newly created persistence mechanisms
- `REMOVED_*.txt` - Deleted items
- `MODIFIED_*.txt` - Modified items

## High-Risk File Extensions

The tool flags the following extensions as high-risk:
`.exe`, `.dll`, `.sys`, `.bat`, `.cmd`, `.ps1`, `.vbs`, `.js`, `.jar`, `.msi`, `.scr`, `.com`, `.pif`, `.cpl`, `.hta`, `.wsf`, `.vbe`, `.jse`

## Limitations

- Requires Administrator privileges for full ETW functionality
- Windows only (uses Windows-specific APIs)
- Some persistence mechanisms may require additional detection methods

## Use Cases

- **Malware Analysis**: Understand how malware establishes persistence
- **Security Research**: Study persistence techniques
- **Incident Response**: Identify persistence mechanisms on compromised systems
- **Red Team**: Validate persistence detection capabilities

## License

GPL-3.0 License

## Disclaimer

This tool is intended for security research and authorized testing only. Always obtain proper authorization before analyzing software or systems you do not own.
